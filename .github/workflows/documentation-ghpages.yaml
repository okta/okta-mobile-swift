name: Deploy Documentation

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

env:
  DEVELOPER_DIR: /Applications/Xcode_13.3.app/Contents/Developer

jobs:
  ExportToGHPages:
    name: Export to Github Pages
    runs-on: macos-12
    steps:
    - uses: actions/checkout@master
    - name: Prepare directory
      run: |
        mkdir -p docs/development
    - name: AuthFoundation
      run: |
        swift package \
          --allow-writing-to-directory docs \
          generate-documentation \
          --target AuthFoundation \
          --disable-indexing \
          --transform-for-static-hosting \
          --hosting-base-path /development/AuthFoundation \
          --output-path docs/development/AuthFoundation
        find docs/development/AuthFoundation -type f | while read file; do \
          perl -pi -e 's#/(js|css|documentation|images|videos|data|downloads|img|js|theme-settings.json|metadata.json|index.html|favicon.ico|favicon.svg)#/okta-mobile-swift/development/AuthFoundation/$1#g' "$file"; \
        done
    - name: OktaOAuth2
      run: |
        swift package \
          --allow-writing-to-directory docs \
          generate-documentation \
          --target OktaOAuth2 \
          --disable-indexing \
          --transform-for-static-hosting \
          --hosting-base-path /development/OktaOAuth2 \
          --output-path docs/development/OktaOAuth2
        find docs/development/OktaOAuth2 -type f | while read file; do \
          perl -pi -e 's#/(js|css|documentation|images|videos|data|downloads|img|js|theme-settings.json|metadata.json|index.html|favicon.ico|favicon.svg)#/okta-mobile-swift/development/OktaOAuth2/$1#g' "$file"; \
        done
    - name: WebAuthenticationUI
      run: |
        swift package \
          --allow-writing-to-directory docs \
          generate-documentation \
          --target WebAuthenticationUI \
          --disable-indexing \
          --transform-for-static-hosting \
          --hosting-base-path /development/WebAuthenticationUI \
          --output-path docs/development/WebAuthenticationUI
        find docs/development/WebAuthenticationUI -type f | while read file; do \
          perl -pi -e 's#/(js|css|documentation|images|videos|data|downloads|img|js|theme-settings.json|metadata.json|index.html|favicon.ico|favicon.svg)#/okta-mobile-swift/development/WebAuthenticationUI/$1#g' "$file"; \
        done
    - name: Deploy documentation to Github Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        keep_files: true
